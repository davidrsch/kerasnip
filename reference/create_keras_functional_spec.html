<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Create a Custom Keras Functional API Model Specification for Tidymodels — create_keras_functional_spec • kerasnip</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Create a Custom Keras Functional API Model Specification for Tidymodels — create_keras_functional_spec"><meta name="description" content="This function acts as a factory to generate a new parsnip model
specification based on user-defined blocks of Keras layers using the
Functional API. This allows for creating complex, tunable architectures
with non-linear topologies that integrate seamlessly with the tidymodels
ecosystem."><meta property="og:description" content="This function acts as a factory to generate a new parsnip model
specification based on user-defined blocks of Keras layers using the
Functional API. This allows for creating complex, tunable architectures
with non-linear topologies that integrate seamlessly with the tidymodels
ecosystem."><meta property="og:image" content="https://davidrsch.github.io/kerasnip/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">kerasnip</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/getting-started.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/getting-started.html">Getting Started with kerasnip</a></li>
    <li><a class="dropdown-item" href="../articles/functional-api.html">Building Functional Models with kerasnip</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/davidrsch/kerasnip"><span class="fa fa-github"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Create a Custom Keras Functional API Model Specification for Tidymodels</h1>

      <div class="d-none name"><code>create_keras_functional_spec.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This function acts as a factory to generate a new <code>parsnip</code> model
specification based on user-defined blocks of Keras layers using the
Functional API. This allows for creating complex, tunable architectures
with non-linear topologies that integrate seamlessly with the <code>tidymodels</code>
ecosystem.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">create_keras_functional_spec</span><span class="op">(</span></span>
<span>  <span class="va">model_name</span>,</span>
<span>  <span class="va">layer_blocks</span>,</span>
<span>  mode <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"regression"</span>, <span class="st">"classification"</span><span class="op">)</span>,</span>
<span>  <span class="va">...</span>,</span>
<span>  env <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html" class="external-link">parent.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-model-name">model_name<a class="anchor" aria-label="anchor" href="#arg-model-name"></a></dt>
<dd><p>A character string for the name of the new model
specification function (e.g., "custom_resnet"). This should be a valid R
function name.</p></dd>


<dt id="arg-layer-blocks">layer_blocks<a class="anchor" aria-label="anchor" href="#arg-layer-blocks"></a></dt>
<dd><p>A named list of functions where each function defines a
"block" (a node) in the model graph. The list names are crucial as they
define the names of the nodes. The arguments of each function define how
the nodes are connected. See the "Model Graph Connectivity" section for
details.</p></dd>


<dt id="arg-mode">mode<a class="anchor" aria-label="anchor" href="#arg-mode"></a></dt>
<dd><p>A character string, either "regression" or "classification".</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Reserved for future use. Currently not used.</p></dd>


<dt id="arg-env">env<a class="anchor" aria-label="anchor" href="#arg-env"></a></dt>
<dd><p>The environment in which to create the new model specification
function and its associated <code><a href="https://rdrr.io/r/stats/update.html" class="external-link">update()</a></code> method. Defaults to the calling
environment (<code><a href="https://rdrr.io/r/base/sys.parent.html" class="external-link">parent.frame()</a></code>).</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>Invisibly returns <code>NULL</code>. Its primary side effect is to create a
new model specification function (e.g., <code>custom_resnet()</code>) in the
specified environment and register the model with <code>parsnip</code> so it can be
used within the <code>tidymodels</code> framework.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>This function generates all the boilerplate needed to create a custom,
tunable <code>parsnip</code> model specification that uses the Keras Functional API.
This is ideal for models with complex, non-linear topologies, such as
networks with multiple inputs/outputs or residual connections.</p>
<p>The function inspects the arguments of your <code>layer_blocks</code> functions and
makes them available as tunable parameters in the generated model
specification, prefixed with the block's name (e.g., <code>dense_units</code>).
Common training parameters such as <code>epochs</code> and <code>learn_rate</code> are also added.</p>
    </div>
    <div class="section level2">
    <h2 id="model-graph-connectivity">Model Graph Connectivity<a class="anchor" aria-label="anchor" href="#model-graph-connectivity"></a></h2>


<p><code>kerasnip</code> builds the model's directed acyclic graph by inspecting the
arguments of each function in the <code>layer_blocks</code> list. The connection logic
is as follows:</p><ol><li><p>The <strong>names of the elements</strong> in the <code>layer_blocks</code> list define the names
of the nodes in your graph (e.g., <code>main_input</code>, <code>dense_path</code>, <code>output</code>).</p></li>
<li><p>The <strong>names of the arguments</strong> in each block function specify its inputs.
A block function like <code>my_block &lt;- function(input_a, input_b, ...)</code>
declares that it needs input from the nodes named <code>input_a</code> and <code>input_b</code>.
<code>kerasnip</code> will automatically supply the output tensors from those nodes
when calling <code>my_block</code>.</p></li>
</ol><p>There are two special requirements:</p><ul><li><p><strong>Input Block</strong>: The first block in the list is treated as the input
node. Its function should not take other blocks as input, but it can have
an <code>input_shape</code> argument, which is supplied automatically during fitting.</p></li>
<li><p><strong>Output Block</strong>: Exactly one block must be named <code>"output"</code>. The tensor
returned by this block is used as the final output of the Keras model.</p></li>
</ul><p>A key feature is the automatic creation of <code>num_{block_name}</code> arguments
(e.g., <code>num_dense_path</code>). This allows you to control how many times a block
is repeated, making it easy to tune the depth of your network. A block can
only be repeated if it has exactly one input from another block in the graph.</p>
<p>The new model specification function and its <code><a href="https://rdrr.io/r/stats/update.html" class="external-link">update()</a></code> method are created
in the environment specified by the <code>env</code> argument.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="remove_keras_spec.html">remove_keras_spec()</a></code>, <code><a href="https://parsnip.tidymodels.org/reference/add_on_exports.html" class="external-link">parsnip::new_model_spec()</a></code>,
<code><a href="create_keras_sequential_spec.html">create_keras_sequential_spec()</a></code></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"keras3"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://keras3.posit.co/" class="external-link">keras3</a></span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/parsnip" class="external-link">parsnip</a></span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># 1. Define block functions. These are the building blocks of our model.</span></span></span>
<span class="r-in"><span>  <span class="co"># An input block that receives the data's shape automatically.</span></span></span>
<span class="r-in"><span>  <span class="va">input_block</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input_shape</span><span class="op">)</span> <span class="fu"><a href="https://keras3.posit.co/reference/layer_input.html" class="external-link">layer_input</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="va">input_shape</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># A dense block with a tunable `units` parameter.</span></span></span>
<span class="r-in"><span>  <span class="va">dense_block</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">tensor</span>, <span class="va">units</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="va">tensor</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://keras3.posit.co/reference/layer_dense.html" class="external-link">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="va">units</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># A block that adds two tensors together (for the residual connection).</span></span></span>
<span class="r-in"><span>  <span class="va">add_block</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input_a</span>, <span class="va">input_b</span><span class="op">)</span> <span class="fu"><a href="https://keras3.posit.co/reference/layer_add.html" class="external-link">layer_add</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">input_a</span>, <span class="va">input_b</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># An output block for regression.</span></span></span>
<span class="r-in"><span>  <span class="va">output_block_reg</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">tensor</span><span class="op">)</span> <span class="fu"><a href="https://keras3.posit.co/reference/layer_dense.html" class="external-link">layer_dense</a></span><span class="op">(</span><span class="va">tensor</span>, units <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># 2. Create the spec. The `layer_blocks` list defines the graph.</span></span></span>
<span class="r-in"><span>  <span class="fu">create_keras_functional_spec</span><span class="op">(</span></span></span>
<span class="r-in"><span>    model_name <span class="op">=</span> <span class="st">"my_resnet_spec"</span>,</span></span>
<span class="r-in"><span>    layer_blocks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>      <span class="co"># The names of list elements are the node names.</span></span></span>
<span class="r-in"><span>      main_input <span class="op">=</span> <span class="va">input_block</span>,</span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>      <span class="co"># The argument `main_input` connects this block to the input node.</span></span></span>
<span class="r-in"><span>      dense_path <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">main_input</span>, <span class="va">units</span> <span class="op">=</span> <span class="fl">32</span><span class="op">)</span> <span class="fu">dense_block</span><span class="op">(</span><span class="va">main_input</span>, <span class="va">units</span><span class="op">)</span>,</span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>      <span class="co"># This block's arguments connect it to the original input AND the dense layer.</span></span></span>
<span class="r-in"><span>      add_residual <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">main_input</span>, <span class="va">dense_path</span><span class="op">)</span> <span class="fu">add_block</span><span class="op">(</span><span class="va">main_input</span>, <span class="va">dense_path</span><span class="op">)</span>,</span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>      <span class="co"># This block must be named 'output'. It connects to the residual add layer.</span></span></span>
<span class="r-in"><span>      output <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">add_residual</span><span class="op">)</span> <span class="fu">output_block_reg</span><span class="op">(</span><span class="va">add_residual</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="op">)</span>,</span></span>
<span class="r-in"><span>    mode <span class="op">=</span> <span class="st">"regression"</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># 3. Use the newly created specification function!</span></span></span>
<span class="r-in"><span>  <span class="co"># The `dense_path_units` argument was created automatically.</span></span></span>
<span class="r-in"><span>  <span class="va">model_spec</span> <span class="op">&lt;-</span> <span class="fu">my_resnet_spec</span><span class="op">(</span>dense_path_units <span class="op">=</span> <span class="fl">64</span>, epochs <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># You could also tune the number of dense layers since it has a single input:</span></span></span>
<span class="r-in"><span>  <span class="co"># model_spec &lt;- my_resnet_spec(num_dense_path = 2, dense_path_units = 32)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">model_spec</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="co"># tune::tunable(model_spec)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by David Díaz.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

