<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>The Sequential Model with kerasnip • kerasnip</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="The Sequential Model with kerasnip">
<!-- Future google search metadata tag --><meta name="google-site-verification" content="kphyQu6n4JhBUuoLZxnJpD9dbw9q5FLwqXb9AkI2fhU">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">kerasnip</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/getting_started.html">Getting started</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-guides" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Guides</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-guides">
<li><h6 class="dropdown-header" data-toc-skip>Model Definition</h6></li>
    <li><a class="dropdown-item" href="../articles/sequential_model.html">Sequential Model</a></li>
    <li><a class="dropdown-item" href="../articles/functional_api.html">Functional API</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/davidrsch/kerasnip"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>The Sequential Model with kerasnip</h1>
            
      

      <div class="d-none name"><code>sequential_model.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette provides a comprehensive guide to using
<code>kerasnip</code> to define sequential Keras models within the
<code>tidymodels</code> ecosystem. <code>kerasnip</code> bridges the gap
between the imperative, layer-by-layer construction of Keras models and
the declarative, specification-based approach of
<code>tidymodels</code>.</p>
<p>Here, we will focus on <code><a href="../reference/create_keras_sequential_spec.html">create_keras_sequential_spec()</a></code>,
which is ideal for models where layers form a plain stack, with each
layer having exactly one input tensor and one output tensor.</p>
</div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>We’ll start by loading the necessary packages:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">kerasnip</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org" class="external-link">tidymodels</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Attaching packages</span> ────────────────────────────────────── tidymodels 1.3.0 ──</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">broom       </span> 1.0.9     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">recipes     </span> 1.3.1</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">dials       </span> 1.4.1     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">rsample     </span> 1.3.1</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">dplyr       </span> 1.1.4     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tibble      </span> 3.3.0</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">ggplot2     </span> 3.5.2     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tidyr       </span> 1.3.1</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">infer       </span> 1.0.9     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tune        </span> 1.3.0</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">modeldata   </span> 1.5.0     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">workflows   </span> 1.2.0</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">parsnip     </span> 1.3.2     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">workflowsets</span> 1.1.1</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">purrr       </span> 1.1.0     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">yardstick   </span> 1.3.2</span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Conflicts</span> ───────────────────────────────────────── tidymodels_conflicts() ──</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">purrr</span>::<span style="color: #00BB00;">discard()</span> masks <span style="color: #0000BB;">scales</span>::discard()</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">dplyr</span>::<span style="color: #00BB00;">filter()</span>  masks <span style="color: #0000BB;">stats</span>::filter()</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">dplyr</span>::<span style="color: #00BB00;">lag()</span>     masks <span style="color: #0000BB;">stats</span>::lag()</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">recipes</span>::<span style="color: #00BB00;">step()</span>  masks <span style="color: #0000BB;">stats</span>::step()</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://keras3.posit.co/" class="external-link">keras3</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'keras3'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:yardstick':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     get_weights</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="when-to-use-create_keras_sequential_spec">When to use <code>create_keras_sequential_spec()</code><a class="anchor" aria-label="anchor" href="#when-to-use-create_keras_sequential_spec"></a>
</h2>
<p>A <code>Sequential</code> model in Keras is appropriate for a plain
stack of layers where each layer has exactly one input tensor and one
output tensor. <code>kerasnip</code>’s
<code><a href="../reference/create_keras_sequential_spec.html">create_keras_sequential_spec()</a></code> function is designed to
define such models in a <code>tidymodels</code>-compatible way.</p>
<p>Instead of building the model layer-by-layer imperatively, you define
a named, ordered list of R functions called <code>layer_blocks</code>.
Each <code>layer_block</code> function takes a Keras model object as its
first argument and returns the modified model. <code>kerasnip</code>
then uses these blocks to construct the full Keras Sequential model.</p>
<p>For models with more complex, non-linear topologies (e.g., multiple
inputs/outputs, residual connections, or multi-branch models), you
should use <code><a href="../reference/create_keras_functional_spec.html">create_keras_functional_spec()</a></code>.</p>
</div>
<div class="section level2">
<h2 id="creating-a-kerasnip-sequential-model-specification">Creating a <code>kerasnip</code> Sequential Model Specification<a class="anchor" aria-label="anchor" href="#creating-a-kerasnip-sequential-model-specification"></a>
</h2>
<p>Let’s define a simple sequential model with three dense layers.</p>
<p>First, we define our <code>layer_blocks</code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The first block must initialize the model. `input_shape` is passed automatically.</span></span>
<span><span class="va">input_block</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">input_shape</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://keras3.posit.co/reference/keras_model_sequential.html" class="external-link">keras_model_sequential</a></span><span class="op">(</span>input_shape <span class="op">=</span> <span class="va">input_shape</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># A reusable block for hidden layers. `units` will become a tunable parameter.</span></span>
<span><span class="va">hidden_block</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">units</span> <span class="op">=</span> <span class="fl">32</span>, <span class="va">activation</span> <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://keras3.posit.co/reference/layer_dense.html" class="external-link">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="va">units</span>, activation <span class="op">=</span> <span class="va">activation</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># The output block. `num_classes` is passed automatically for classification.</span></span>
<span><span class="va">output_block</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">num_classes</span>, <span class="va">activation</span> <span class="op">=</span> <span class="st">"softmax"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://keras3.posit.co/reference/layer_dense.html" class="external-link">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="va">num_classes</span>, activation <span class="op">=</span> <span class="va">activation</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now, we use <code><a href="../reference/create_keras_sequential_spec.html">create_keras_sequential_spec()</a></code> to generate
our <code>parsnip</code> model specification function. We’ll name our
model <code>my_simple_mlp</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/create_keras_sequential_spec.html">create_keras_sequential_spec</a></span><span class="op">(</span></span>
<span>  model_name <span class="op">=</span> <span class="st">"my_simple_mlp"</span>,</span>
<span>  layer_blocks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    input <span class="op">=</span> <span class="va">input_block</span>,</span>
<span>    hidden_1 <span class="op">=</span> <span class="va">hidden_block</span>,</span>
<span>    hidden_2 <span class="op">=</span> <span class="va">hidden_block</span>,</span>
<span>    output <span class="op">=</span> <span class="va">output_block</span></span>
<span>  <span class="op">)</span>,</span>
<span>  mode <span class="op">=</span> <span class="st">"classification"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="a-common-debugging-workflow-compile_keras_grid">A common debugging workflow: <code>compile_keras_grid()</code><a class="anchor" aria-label="anchor" href="#a-common-debugging-workflow-compile_keras_grid"></a>
</h2>
<p>In the original Keras guide, a common workflow is to incrementally
add layers and call <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> to inspect the architecture.
With <code>kerasnip</code>, the model is defined declaratively, so we
can’t inspect it layer-by-layer in the same way.</p>
<p>However, <code>kerasnip</code> provides a powerful equivalent:
<code><a href="../reference/compile_keras_grid.html">compile_keras_grid()</a></code>. This function checks if your
<code>layer_blocks</code> define a valid Keras model and returns the
compiled model structure, all without running a full training cycle.
This is perfect for debugging your architecture.</p>
<p>Let’s see this in action with a CNN architecture:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define CNN layer blocks</span></span>
<span><span class="va">cnn_input_block</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">input_shape</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://keras3.posit.co/reference/keras_model_sequential.html" class="external-link">keras_model_sequential</a></span><span class="op">(</span>input_shape <span class="op">=</span> <span class="va">input_shape</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">cnn_conv_block</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">filters</span> <span class="op">=</span> <span class="fl">32</span>, <span class="va">kernel_size</span> <span class="op">=</span> <span class="fl">3</span>, <span class="va">activation</span> <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://keras3.posit.co/reference/layer_conv_2d.html" class="external-link">layer_conv_2d</a></span><span class="op">(</span>filters <span class="op">=</span> <span class="va">filters</span>, kernel_size <span class="op">=</span> <span class="va">kernel_size</span>, activation <span class="op">=</span> <span class="va">activation</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">cnn_pool_block</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">pool_size</span> <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://keras3.posit.co/reference/layer_max_pooling_2d.html" class="external-link">layer_max_pooling_2d</a></span><span class="op">(</span>pool_size <span class="op">=</span> <span class="va">pool_size</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">cnn_flatten_block</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://keras3.posit.co/reference/layer_flatten.html" class="external-link">layer_flatten</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">cnn_output_block</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">num_classes</span>, <span class="va">activation</span> <span class="op">=</span> <span class="st">"softmax"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://keras3.posit.co/reference/layer_dense.html" class="external-link">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="va">num_classes</span>, activation <span class="op">=</span> <span class="va">activation</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Create the kerasnip spec function</span></span>
<span><span class="fu"><a href="../reference/create_keras_sequential_spec.html">create_keras_sequential_spec</a></span><span class="op">(</span></span>
<span>  model_name <span class="op">=</span> <span class="st">"my_cnn"</span>,</span>
<span>  layer_blocks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    input <span class="op">=</span> <span class="va">cnn_input_block</span>,</span>
<span>    conv1 <span class="op">=</span> <span class="va">cnn_conv_block</span>,</span>
<span>    pool1 <span class="op">=</span> <span class="va">cnn_pool_block</span>,</span>
<span>    flatten <span class="op">=</span> <span class="va">cnn_flatten_block</span>,</span>
<span>    output <span class="op">=</span> <span class="va">cnn_output_block</span></span>
<span>  <span class="op">)</span>,</span>
<span>  mode <span class="op">=</span> <span class="st">"classification"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a spec instance for a 28x28x1 image</span></span>
<span><span class="va">cnn_spec</span> <span class="op">&lt;-</span> <span class="fu">my_cnn</span><span class="op">(</span></span>
<span>  conv1_filters <span class="op">=</span> <span class="fl">32</span>, conv1_kernel_size <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  compile_loss <span class="op">=</span> <span class="st">"categorical_crossentropy"</span>,</span>
<span>  compile_optimizer <span class="op">=</span> <span class="st">"adam"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Prepare dummy data with the correct shape.</span></span>
<span><span class="co"># We create a list of 28x28x1 arrays.</span></span>
<span><span class="va">x_dummy_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">28</span><span class="op">*</span><span class="fl">28</span><span class="op">*</span><span class="fl">1</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">28</span>, <span class="fl">28</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x_dummy_df</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_dummy_list</span><span class="op">)</span></span>
<span><span class="va">y_dummy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">9</span>, <span class="fl">10</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span></span>
<span><span class="va">y_dummy_df</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y_dummy</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Use compile_keras_grid to get the model summary</span></span>
<span><span class="va">compilation_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compile_keras_grid.html">compile_keras_grid</a></span><span class="op">(</span></span>
<span>  spec <span class="op">=</span> <span class="va">cnn_spec</span>,</span>
<span>  grid <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>  x <span class="op">=</span> <span class="va">x_dummy_df</span>,</span>
<span>  y <span class="op">=</span> <span class="va">y_dummy_df</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the summary</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">compilation_results</span><span class="op">$</span><span class="va">compiled_model</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Model: "sequential"</span></span></span>
<span><span class="co">#&gt; ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓</span></span>
<span><span class="co">#&gt; ┃<span style="font-weight: bold;"> Layer (type)                      </span>┃<span style="font-weight: bold;"> Output Shape             </span>┃<span style="font-weight: bold;">       Param # </span>┃</span></span>
<span><span class="co">#&gt; ┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩</span></span>
<span><span class="co">#&gt; │ conv2d (<span style="color: #0087FF;">Conv2D</span>)                   │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">24</span>, <span style="color: #00AF00;">24</span>, <span style="color: #00AF00;">32</span>)       │           <span style="color: #00AF00;">832</span> │</span></span>
<span><span class="co">#&gt; ├───────────────────────────────────┼──────────────────────────┼───────────────┤</span></span>
<span><span class="co">#&gt; │ max_pooling2d (<span style="color: #0087FF;">MaxPooling2D</span>)      │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">12</span>, <span style="color: #00AF00;">12</span>, <span style="color: #00AF00;">32</span>)       │             <span style="color: #00AF00;">0</span> │</span></span>
<span><span class="co">#&gt; ├───────────────────────────────────┼──────────────────────────┼───────────────┤</span></span>
<span><span class="co">#&gt; │ flatten (<span style="color: #0087FF;">Flatten</span>)                 │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">4608</span>)             │             <span style="color: #00AF00;">0</span> │</span></span>
<span><span class="co">#&gt; ├───────────────────────────────────┼──────────────────────────┼───────────────┤</span></span>
<span><span class="co">#&gt; │ dense (<span style="color: #0087FF;">Dense</span>)                     │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">10</span>)               │        <span style="color: #00AF00;">46,090</span> │</span></span>
<span><span class="co">#&gt; └───────────────────────────────────┴──────────────────────────┴───────────────┘</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;"> Total params: </span><span style="color: #00AF00;">46,922</span> (183.29 KB)</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;"> Trainable params: </span><span style="color: #00AF00;">46,922</span> (183.29 KB)</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;"> Non-trainable params: </span><span style="color: #00AF00;">0</span> (0.00 B)</span></span></code></pre></div>
<!-- ## What to do once you have a model -->
<!-- -->
<!-- Once your model architecture is ready, you will want to: -->
<!-- -->
<!-- TODO: Create vignettes for the following guides and uncomment these links: -->
<!-- -->
<!-- - [Train your model, evaluate it, and run inference](https://keras3.posit.co/articles/training_and_evaluation.html) -->
<!-- - [Save your model to disk and restore it](https://keras3.posit.co/articles/serialization_and_saving.html) -->
</div>
<div class="section level2">
<h2 id="feature-extraction-with-a-sequential-model">Feature Extraction with a Sequential Model<a class="anchor" aria-label="anchor" href="#feature-extraction-with-a-sequential-model"></a>
</h2>
<p>Once a Sequential model has been built, it behaves like a Functional
API model. This means that every layer has an input and output
attribute. In <code>kerasnip</code>, we can get access to this
underlying model structure using <code><a href="../reference/compile_keras_grid.html">compile_keras_grid()</a></code>.</p>
<p>This allows us to create a new model that outputs the values of the
intermediate layers.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># We can reuse the compilation results from the previous chunk</span></span>
<span><span class="va">keras_model_obj</span> <span class="op">&lt;-</span> <span class="va">compilation_results</span><span class="op">$</span><span class="va">compiled_model</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Create a new Keras model for feature extraction</span></span>
<span><span class="va">feature_extractor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://keras3.posit.co/reference/keras_model.html" class="external-link">keras_model</a></span><span class="op">(</span></span>
<span>  inputs <span class="op">=</span> <span class="va">keras_model_obj</span><span class="op">$</span><span class="va">inputs</span>,</span>
<span>  outputs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">keras_model_obj</span><span class="op">$</span><span class="va">layers</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">output</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Call the feature extractor on a dummy input tensor</span></span>
<span><span class="va">x_tensor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://keras3.posit.co/reference/op_ones.html" class="external-link">op_ones</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">28</span>, <span class="fl">28</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">features</span> <span class="op">&lt;-</span> <span class="fu">feature_extractor</span><span class="op">(</span><span class="va">x_tensor</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the shapes of the extracted feature maps</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">features</span>, <span class="va">dim</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [1]  1 24 24 32</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [1]  1 12 12 32</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt; [1]    1 4608</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[4]]</span></span>
<span><span class="co">#&gt; [1]  1 10</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="transfer-learning-with-a-sequential-model">Transfer Learning with a Sequential Model<a class="anchor" aria-label="anchor" href="#transfer-learning-with-a-sequential-model"></a>
</h2>
<!-- TODO: Create a vignette for the transfer learning guide and uncomment this link: -->
<!-- If you aren’t familiar with it, make sure to read our [guide to transfer learning](https://keras3.posit.co/articles/transfer_learning.html). -->
<p>Transfer learning consists of freezing the bottom layers in a model
and only training the top layers. A common blueprint is to use a
Sequential model to stack a pre-trained model and some freshly
initialized classification layers.</p>
<p><code>kerasnip</code> supports this by allowing a
<code>layer_block</code> to contain a pre-trained model.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define a block that incorporates a pre-trained base</span></span>
<span><span class="co"># This block creates a new sequential model and adds the pre-trained,</span></span>
<span><span class="co"># frozen base model as its first layer.</span></span>
<span><span class="va">pretrained_base_block</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">input_shape</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">base_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://keras3.posit.co/reference/application_xception.html" class="external-link">application_xception</a></span><span class="op">(</span></span>
<span>    weights <span class="op">=</span> <span class="st">"imagenet"</span>,</span>
<span>    include_top <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    pooling <span class="op">=</span> <span class="st">"avg"</span>,</span>
<span>    input_shape <span class="op">=</span> <span class="va">input_shape</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="co"># Freeze the weights of the pre-trained base</span></span>
<span>  <span class="fu"><a href="https://keras3.posit.co/reference/freeze_weights.html" class="external-link">freeze_weights</a></span><span class="op">(</span><span class="va">base_model</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># The block must return a sequential model</span></span>
<span>  <span class="fu"><a href="https://keras3.posit.co/reference/keras_model_sequential.html" class="external-link">keras_model_sequential</a></span><span class="op">(</span>input_shape <span class="op">=</span> <span class="va">input_shape</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">base_model</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Define a new classification head. This block will be appended to the</span></span>
<span><span class="co"># sequential model returned by the previous block.</span></span>
<span><span class="va">classification_head_block</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">num_classes</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">model</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://keras3.posit.co/reference/layer_dense.html" class="external-link">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1000</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://keras3.posit.co/reference/layer_dense.html" class="external-link">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="va">num_classes</span>, activation <span class="op">=</span> <span class="st">"softmax"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Create a new kerasnip spec with the pre-trained base and new head</span></span>
<span><span class="fu"><a href="../reference/create_keras_sequential_spec.html">create_keras_sequential_spec</a></span><span class="op">(</span></span>
<span>  model_name <span class="op">=</span> <span class="st">"transfer_cnn"</span>,</span>
<span>  layer_blocks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    base <span class="op">=</span> <span class="va">pretrained_base_block</span>,</span>
<span>    head <span class="op">=</span> <span class="va">classification_head_block</span></span>
<span>  <span class="op">)</span>,</span>
<span>  mode <span class="op">=</span> <span class="st">"classification"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a spec instance</span></span>
<span><span class="va">transfer_spec</span> <span class="op">&lt;-</span> <span class="fu">transfer_cnn</span><span class="op">(</span></span>
<span>  compile_loss <span class="op">=</span> <span class="st">"categorical_crossentropy"</span>,</span>
<span>  compile_optimizer <span class="op">=</span> <span class="st">"adam"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Prepare dummy data for a 224x224x3 image</span></span>
<span><span class="va">x_dummy_tl_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">224</span><span class="op">*</span><span class="fl">224</span><span class="op">*</span><span class="fl">3</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">224</span>, <span class="fl">224</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x_dummy_tl_df</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_dummy_tl_list</span><span class="op">)</span></span>
<span><span class="va">y_dummy_tl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">9</span>, <span class="fl">10</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span></span>
<span><span class="va">y_dummy_tl_df</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y_dummy_tl</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Use compile_keras_grid to inspect the model and trainable parameters</span></span>
<span><span class="va">compilation_results_tl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compile_keras_grid.html">compile_keras_grid</a></span><span class="op">(</span></span>
<span>  spec <span class="op">=</span> <span class="va">transfer_spec</span>,</span>
<span>  grid <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  x <span class="op">=</span> <span class="va">x_dummy_tl_df</span>,</span>
<span>  y <span class="op">=</span> <span class="va">y_dummy_tl_df</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Downloading data from https://storage.googleapis.com/tensorflow/keras-applications/xception/xception_weights_tf_dim_ordering_tf_kernels_notop.h5</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">       0/83683744</span> <span style="color: #BBBBBB;">━━━━━━━━━━━━━━━━━━━━</span> <span style="font-weight: bold;">0s</span> 0s/step<span style="font-weight: bold;">11509760/83683744</span> <span style="color: #00BB00;">━━</span><span style="color: #BBBBBB;">━━━━━━━━━━━━━━━━━━</span> <span style="font-weight: bold;">0s</span> 0us/step<span style="font-weight: bold;">29065216/83683744</span> <span style="color: #00BB00;">━━━━━━</span><span style="color: #BBBBBB;">━━━━━━━━━━━━━━</span> <span style="font-weight: bold;">0s</span> 0us/step<span style="font-weight: bold;">44720128/83683744</span> <span style="color: #00BB00;">━━━━━━━━━━</span><span style="color: #BBBBBB;">━━━━━━━━━━</span> <span style="font-weight: bold;">0s</span> 0us/step<span style="font-weight: bold;">51585024/83683744</span> <span style="color: #00BB00;">━━━━━━━━━━━━</span><span style="color: #BBBBBB;">━━━━━━━━</span> <span style="font-weight: bold;">0s</span> 0us/step<span style="font-weight: bold;">68247552/83683744</span> <span style="color: #00BB00;">━━━━━━━━━━━━━━━━</span><span style="color: #BBBBBB;">━━━━</span> <span style="font-weight: bold;">0s</span> 0us/step<span style="font-weight: bold;">83683744/83683744</span> <span style="color: #00BB00;">━━━━━━━━━━━━━━━━━━━━</span> <span style="font-weight: bold;">0s</span> 0us/step</span></span>
<span></span>
<span><span class="co"># Print the summary to verify that the base model's parameters are non-trainable</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">compilation_results_tl</span><span class="op">$</span><span class="va">compiled_model</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Model: "sequential_2"</span></span></span>
<span><span class="co">#&gt; ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━┓</span></span>
<span><span class="co">#&gt; ┃<span style="font-weight: bold;"> Layer (type)                  </span>┃<span style="font-weight: bold;"> Output Shape           </span>┃<span style="font-weight: bold;">     Param # </span>┃<span style="font-weight: bold;"> Trai… </span>┃</span></span>
<span><span class="co">#&gt; ┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━┩</span></span>
<span><span class="co">#&gt; │ xception (<span style="color: #0087FF;">Functional</span>)         │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">2048</span>)           │  <span style="color: #00AF00;">20,861,480</span> │   <span style="color: #FF5555; font-weight: bold;">N</span>   │</span></span>
<span><span class="co">#&gt; ├───────────────────────────────┼────────────────────────┼─────────────┼───────┤</span></span>
<span><span class="co">#&gt; │ dense_2 (<span style="color: #0087FF;">Dense</span>)               │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">1000</span>)           │   <span style="color: #00AF00;">2,049,000</span> │   <span style="color: #00AF00; font-weight: bold;">Y</span>   │</span></span>
<span><span class="co">#&gt; ├───────────────────────────────┼────────────────────────┼─────────────┼───────┤</span></span>
<span><span class="co">#&gt; │ dense_3 (<span style="color: #0087FF;">Dense</span>)               │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">10</span>)             │      <span style="color: #00AF00;">10,010</span> │   <span style="color: #00AF00; font-weight: bold;">Y</span>   │</span></span>
<span><span class="co">#&gt; └───────────────────────────────┴────────────────────────┴─────────────┴───────┘</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;"> Total params: </span><span style="color: #00AF00;">22,920,490</span> (87.43 MB)</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;"> Trainable params: </span><span style="color: #00AF00;">2,059,010</span> (7.85 MB)</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;"> Non-trainable params: </span><span style="color: #00AF00;">20,861,480</span> (79.58 MB)</span></span></code></pre></div>
<!-- To find out more about building models in Keras, see: -->
<!-- TODO: Create vignettes for the following guides and uncomment these links: -->
<!-- -->
<!-- - [The Functional API](https://keras3.posit.co/articles/functional_api.html) -->
<!-- - [Making new Layers & Models via subclassing](https://keras3.posit.co/articles/making_new_layers_and_models_via_subclassing.html) -->
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by David Díaz.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
